<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:haf="https://github.com/haf/NLog.RabbitMQ/raw/master/src/schemas/NLog.RabbitMQ.xsd"
      internalLogFile="logs\nlog-error-log.csv"
      internalLogLevel="Info"
      autoReload="true"
      >
  <!-- 
  WARNING: 
    THIS FILE IS AUTOMATICALLY INSTALLED THROUGH A NUGET PACKAGE. 
    DO NOT MAKE ANY MODIFICATION TO THIS FILE.
    CUSTOM NLOG CONFIG SHOULD BE ADDED TO: NLog.Custom.config
  -->

  <variable name="Env" value="${environment:OTEL_ENV:default=local}"/>

  <extensions>
    <!--<add assembly="Serilog.Sinks.OpenTelemetry"/>-->
    <add assembly="NLog.Targets.ElasticSearch"/>
    <add assembly="NLog.Targets.OpenTelemetry"/>
    <add assembly="NLog.DiagnosticSource"/>
  </extensions>

  <targets>
    <default-wrapper xsi:type="AsyncWrapper" overflowAction="Grow" timeToSleepBetweenBatches="10"  />
    <target name="UDP1" xsi:type="NLogViewer" address="udp://127.0.0.1:5557" connectionCacheSize="100" keepConnection="true"
            includeNdc="true"
            includeNLogData="true"
            includeMdc="true"
            includeCallSite="true"
            includeSourceInfo="true">
      <parameter name="Exceptions" layout = "${exception:format=type,message,StackTrace:maxInnerExceptionLevel=10:innerFormat=type,message,StackTrace}" />
      <parameter name="ProcessName" layout= "${processname}" />
      <parameter name="ProcessID" layout="${processid}" />
      <parameter name="ThreadName" layout="${threadname}" />
      <parameter name="Class" layout ="${callsite:className=true:methodName=false:fileName=false:includeSourcePath=false}" />
      <parameter name="Method" layout ="${callsite:className=false:methodName=true:fileName=false:includeSourcePath=false}" />
      <parameter name="File" layout ="${callsite:className=false:methodName=false:fileName=true:includeSourcePath=true}" />
    </target>

    <target name="Otel" type="Otel" OtlpEndpoint="http://localhost:4317"
            ServiceName="test-logging-service"
            ServiceVersion="1.2.3"
            Environment="${Env}"
            IncludeMessageTemplateText="true"
            IncludeMessageTemplateMD5Hash="true"
            >
      <attributes>
        <!--<attribute name="code.class" layout ="${callsite:className=true:methodName=false:fileName=false:includeSourcePath=false}" />
        <attribute name="code.method" layout ="${callsite:className=false:methodName=true:fileName=false:includeSourcePath=false}" />-->
        <attribute name="ddtags" layout ="foo:bar, stable:false" />
        <!--<attribute name="thread.id" layout="${threadid}"/>
        <attribute name="thread.name" layout="${threadname}" />-->
        <!--<attribute name="CorrelationId" layout="${CorellationId}" />
        <attribute name="OperationName" layout="${activity:property=OperationName}" />-->
        <!--<attribute name="trace.baggage" layout="${TraceBaggage:Format=@}" layoutType="System.Object"/>
        <attribute name="trace.tags" layout="${TraceTags:Format=@}" layoutType="System.Object"/>-->

      </attributes>
    </target>

    <target xsi:type="ElasticSearch"
            name="ElasticSearch"
            uri="http://localhost:9200/"
            layout="${message}"
            includeAllProperties="true"
            username="elastic"
            password="changeme"
    >
      <field name="Environment" layout="${gdc:item=Environment}" />
      <field name="Exceptions" layout = "${exception:format=type,message,StackTrace:maxInnerExceptionLevel=10:innerFormat=type,message,StackTrace}" />
      <field name="ProcessName" layout= "${processname}" />
      <field name="ProcessID" layout="${processid}" />
      <field name="ThreadID" layout="${threadid}"/>
      <field name="ThreadName" layout="${threadname}" />
      <field name="Class" layout ="${callsite:className=true:methodName=false:fileName=false:includeSourcePath=false}" />
      <field name="Method" layout ="${callsite:className=false:methodName=true:fileName=false:includeSourcePath=false}" />
      <field name="Message" layout="${message}" />
      <field name="File" layout ="${callsite:className=false:methodName=false:fileName=true:includeSourcePath=true}" />
      <field name="ServiceName" layout="${gdc:item=ServiceName}" />
      <field name="service.name" layout="${gdc:item=ServiceNameShort}" />
      <field name="MachineName" layout="${machinename}" />
      <field name="trace.id" layout="${activity:property=TraceId}" />
      <field name="parent.id" layout="${activity:property=ParentId}" />
      <field name="span.id" layout="${activity:property=SpanId}" />
      <field name="OperationName" layout="${activity:property=OperationName}" />
      <field name="trace.baggage" layout="${TraceBaggage:Format=@}" layoutType="System.Object"/>
      <field name="trace.tags" layout="${TraceTags:Format=@}" layoutType="System.Object"/>
    </target>
  </targets>

  <rules>

    <!-- Only log Microsoft.* from Warn level and above: -->
    <logger name="Microsoft.*" maxlevel="Info" final="true" />

    <logger name="*" minlevel="Trace" writeTo="Otel" />
    <logger name="*" minlevel="Trace" writeTo="ElasticSearch" />
    <!-- Uncomment the below if you want to log to UDP: -->
    <logger name="*" minlevel="Trace" writeTo="UDP1" />

    
  </rules>
</nlog>
